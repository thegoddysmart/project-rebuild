generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

enum Role {
  SUPER_ADMIN
  ADMIN
  ORGANIZER
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

model User {
  id             String            @id @default(cuid())
  email          String            @unique
  passwordHash   String?
  name           String
  phone          String?
  avatar         String?
  role           Role              @default(ORGANIZER)
  status         UserStatus        @default(PENDING)
  emailVerified  DateTime?
  lastLoginAt    DateTime?
  organizerProfile OrganizerProfile?
  sessions       Session[]
  activityLogs   ActivityLog[]
  cmsContents    CMSContent[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([email])
  @@index([role])
  @@index([status])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String
  entityType  String?
  entityId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================
// ORGANIZER PROFILE
// ============================================

model OrganizerProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessName    String
  businessEmail   String?
  businessPhone   String?
  address         String?
  city            String?
  region          String?
  logo            String?
  description     String?
  website         String?
  bankName        String?
  bankAccountName String?
  bankAccountNumber String?
  commissionRate  Decimal   @default(10.00) @db.Decimal(5, 2)
  balance         Decimal   @default(0) @db.Decimal(12, 2)
  pendingBalance  Decimal   @default(0) @db.Decimal(12, 2) // For held funds/waitlist
  totalRevenue    Decimal   @default(0) @db.Decimal(12, 2)
  verified        Boolean   @default(false)
  verifiedAt      DateTime?
  events          Event[]
  payouts         Payout[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([verified])
}

// ============================================
// EVENTS
// ============================================

enum EventType {
  VOTING
  TICKETING
  HYBRID
}

enum EventStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  LIVE        // @deprecated - kept for backward compatibility
  PAUSED
  ENDED
  CANCELLED
  ARCHIVED
}

model Event {
  id              String          @id @default(cuid())
  eventCode       String          @unique
  title           String
  description     String?
  type            EventType       @default(VOTING)
  showVoteCount   Boolean         @default(true)
  showLiveResults Boolean         @default(true)
  showSalesEnd    Boolean         @default(false)
  status          EventStatus     @default(DRAFT)
  coverImage      String?
  bannerImage     String?
  startDate       DateTime
  endDate         DateTime
  timezone        String          @default("Africa/Accra")
  votePrice       Decimal?        @db.Decimal(10, 2)
  minVotes        Int             @default(1)
  maxVotes        Int?
  location        String?
  venue           String?
  isPublic        Boolean         @default(true)
  
  // Lifecycle & Timeline Management
  isNominationOpen   Boolean      @default(false)
  nominationStartsAt DateTime?
  nominationEndsAt   DateTime?
  
  isVotingOpen       Boolean      @default(false)
  votingStartsAt     DateTime?
  votingEndsAt       DateTime?

  allowNominations Boolean        @default(false)
  nominationDeadline DateTime?    // @deprecated - use nominationEndsAt
  organizerId     String
  organizer       OrganizerProfile @relation(fields: [organizerId], references: [id])
  categories      EventCategory[]
  ticketTypes     TicketType[]
  nominations     Nomination[]
  nominationForm  EventNominationForm?
  transactions    Transaction[]
  totalVotes      Int             @default(0)
  totalRevenue    Decimal         @default(0) @db.Decimal(12, 2)
  settings        Json?
  metadata        Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  publishedAt     DateTime?

  @@index([eventCode])
  @@index([status])
  @@index([type])
  @@index([organizerId])
  @@index([startDate, endDate])
}

// ============================================
// CATEGORIES & CANDIDATES
// ============================================

model EventCategory {
  id          String      @id @default(cuid())
  eventId     String
  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name        String
  description String?
  image       String?
  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)
  candidates  Candidate[]
  nominations Nomination[]
  totalVotes  Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([eventId])
  @@index([sortOrder])
}

model Candidate {
  id          String        @id @default(cuid())
  categoryId  String
  category    EventCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  code        String
  name        String
  image       String?
  bio         String?
  socialLinks Json?
  sortOrder   Int           @default(0)
  isActive    Boolean       @default(true)
  nominationId String?      @unique
  nomination   Nomination?  @relation(fields: [nominationId], references: [id])
  votes       Vote[]
  voteCount   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([categoryId, code])
  @@index([categoryId])
  @@index([voteCount])
}

// ============================================
// VOTING
// ============================================

model Vote {
  id            String      @id @default(cuid())
  candidateId   String
  candidate     Candidate   @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  quantity      Int         @default(1)
  voterPhone    String?
  voterEmail    String?
  voterName     String?
  metadata      Json?
  createdAt     DateTime    @default(now())

  @@index([candidateId])
  @@index([transactionId])
  @@index([createdAt])
}

// ============================================
// TICKETING
// ============================================

model TicketType {
  id            String    @id @default(cuid())
  eventId       String
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  price         Decimal   @db.Decimal(10, 2)
  quantity      Int
  soldCount     Int       @default(0)
  maxPerOrder   Int       @default(10)
  salesStart    DateTime?
  salesEnd      DateTime?
  isActive      Boolean   @default(true)
  sortOrder     Int       @default(0)
  tickets       Ticket[]
  reservations  TicketReservation[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([eventId])
}

enum ReservationStatus {
  RESERVED
  CONFIRMED
  EXPIRED
  CANCELLED
}

model TicketReservation {
  id            String            @id @default(cuid())
  ticketTypeId  String
  ticketType    TicketType        @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  eventId       String
  quantity      Int
  expiresAt     DateTime
  status        ReservationStatus @default(RESERVED)
  reference     String?           @unique // Links to Transaction reference if needed
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([ticketTypeId])
  @@index([eventId])
  @@index([status])
  @@index([expiresAt])
}

model Ticket {
  id            String      @id @default(cuid())
  eventId       String?     // Added for faster lookup
  ticketTypeId  String
  ticketType    TicketType  @relation(fields: [ticketTypeId], references: [id])
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  ticketCode    String      @unique
  holderName    String?
  holderEmail   String?
  holderPhone   String?
  isCheckedIn   Boolean     @default(false)
  checkedInAt   DateTime?
  checkedInBy   String?
  qrCode        String?
  metadata      Json?
  createdAt     DateTime    @default(now())

  @@index([eventId])
  @@index([ticketTypeId])
  @@index([transactionId])
  @@index([ticketCode])
}

// ============================================
// NOMINATIONS
// ============================================

enum NominationStatus {
  DRAFT
  PENDING
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  WITHDRAWN
}

enum NominationType {
  SELF
  THIRD_PARTY
}

model Nomination {
  id              String           @id @default(cuid())
  eventId         String
  event           Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  categoryId      String
  category        EventCategory    @relation(fields: [categoryId], references: [id])
  
  // Core Data
  nominationType  NominationType   @default(SELF)
  nomineeName     String
  nomineeEmail    String?
  nomineePhone    String?
  nomineePhotoUrl String?          // Renamed from nomineeImage
  bio             String?
  
  // Nominator Info (Required for THIRD_PARTY)
  nominatorName   String?
  nominatorEmail  String?
  nominatorPhone  String?
  
  // Dynamic Data
  customFields    Json?            // Stores responses to dynamic form fields
  
  // Governance
  status          NominationStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?
  rejectionReason String?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  candidate       Candidate?       // One-to-one relation

  @@index([eventId])
  @@index([categoryId])
  @@index([status])
  @@index([nomineeEmail])
  @@index([nomineePhone])
}

// ============================================
// DYNAMIC NOMINATION FORMS
// ============================================

model EventNominationForm {
  id          String            @id @default(cuid())
  eventId     String            @unique
  event       Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  isActive    Boolean           @default(false)
  whatsappLink String?          // WhatsApp group link for nominees
  fields      NominationField[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

enum NominationFieldType {
  TEXT
  TEXTAREA
  NUMBER
  EMAIL
  PHONE
  SELECT
  MULTI_SELECT
  CHECKBOX
  FILE
  URL
}

model NominationField {
  id          String              @id @default(cuid())
  formId      String
  form        EventNominationForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  key         String              // Unique identifier for the field in this form
  label       String
  type        NominationFieldType
  required    Boolean             @default(false)
  options     Json?               // For SELECT/MULTI_SELECT
  validation  Json?               // Min/Max, Regex, etc.
  order       Int                 @default(0)
  
  @@index([formId])
  @@unique([formId, key])
}

// ============================================
// TRANSACTIONS
// ============================================

enum TransactionType {
  VOTE
  TICKET
  NOMINATION_FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

model Transaction {
  id              String            @id @default(cuid())
  reference       String            @unique
  eventId         String
  event           Event             @relation(fields: [eventId], references: [id])
  type            TransactionType
  amount          Decimal           @db.Decimal(12, 2)
  fee             Decimal           @default(0) @db.Decimal(10, 2)
  commission      Decimal           @default(0) @db.Decimal(10, 2)
  netAmount       Decimal           @db.Decimal(12, 2)
  currency        String            @default("GHS")
  paymentMethod   String
  paymentProvider String
  providerRef     String?
  status          TransactionStatus @default(PENDING)
  customerPhone   String?
  customerEmail   String?
  customerName    String?
  votes           Vote[]
  tickets         Ticket[]
  refunds         Refund[]
  metadata        Json?
  paidAt          DateTime?
  isSimulated     Boolean           @default(false)
  simulationProvider String?        // "APPSN", "PAYSTACK", "USSD"
  simulationOutcome  String?        // "SUCCESS", "FAILED", "EXPIRED"
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([reference])
  @@index([eventId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([paymentMethod])
}

model Refund {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  amount        Decimal     @db.Decimal(12, 2)
  reason        String
  status        String      @default("pending")
  processedBy   String?
  providerRef   String?
  processedAt   DateTime?
  createdAt     DateTime    @default(now())

  @@index([transactionId])
}

// ============================================
// PAYOUTS
// ============================================

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model Payout {
  id              String        @id @default(cuid())
  organizerId     String
  organizer       OrganizerProfile @relation(fields: [organizerId], references: [id])
  amount          Decimal       @db.Decimal(12, 2)
  fee             Decimal       @default(0) @db.Decimal(10, 2)
  netAmount       Decimal       @db.Decimal(12, 2)
  currency        String        @default("GHS")
  status          PayoutStatus  @default(PENDING)
  method          String        @default("BANK") // "MOBILE_MONEY", "BANK_TRANSFER"
  bankName        String
  bankAccountName String
  bankAccountNumber String
  reference       String?       @unique
  providerRef     String?
  processedBy     String?
  processedAt     DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizerId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// CMS CONTENT
// ============================================

enum CMSContentType {
  HOMEPAGE
  ABOUT
  FAQ
  BLOG_POST
  PAGE
}

enum CMSContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model CMSContent {
  id          String           @id @default(cuid())
  type        CMSContentType
  slug        String           @unique
  title       String
  excerpt     String?
  content     Json
  featuredImage String?
  status      CMSContentStatus @default(DRAFT)
  authorId    String
  author      User             @relation(fields: [authorId], references: [id])
  publishedAt DateTime?
  metadata    Json?
  tags        String[]
  viewCount   Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([type])
  @@index([status])
  @@index([slug])
  @@index([authorId])
}

// ============================================
// MEDIA LIBRARY
// ============================================

model Media {
  id          String   @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  thumbnailUrl String?
  altText     String?
  uploadedBy  String
  folder      String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([uploadedBy])
  @@index([folder])
  @@index([createdAt])
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  category    String   @default("general")
  isPublic    Boolean  @default(false)
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([key])
}

model PaymentGatewayConfig {
  id           String    @id @default(cuid())
  provider     String    @unique // "APPSN", "PAYSTACK"
  isEnabled    Boolean   @default(true)
  priority     Int       @default(0) // Higher = Preferred
  failureCount Int       @default(0)
  lastFailure  DateTime?
  updatedAt    DateTime  @updatedAt
}
